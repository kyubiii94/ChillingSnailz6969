<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SNAILZ SNAKE ‚Äî Lettuce Island Arcade</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Syne:wght@400;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ===========================
   VARIABLES & RESET
=========================== */
:root {
  --void: #03040a;
  --deep: #080c18;
  --surface: #0f1628;
  --raised: #162035;
  --aqua: #00d4ff;
  --aqua-dim: rgba(0,212,255,0.15);
  --magma: #ff4500;
  --wizard: #a855f7;
  --chill: #39ff14;
  --chill-dim: rgba(57,255,20,0.15);
  --chill-glow: 0 0 20px rgba(57,255,20,0.5), 0 0 60px rgba(57,255,20,0.2);
  --gold: #ffd700;
  --white: #e8ecf5;
  --muted: #6b7a9b;
  --border: rgba(255,255,255,0.07);
  --font-pixel: 'Press Start 2P', monospace;
  --font-display: 'Syne', sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { overflow-x: hidden; }
body {
  background: var(--void);
  color: var(--white);
  font-family: var(--font-mono);
  overflow-x: hidden;
  line-height: 1.6;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}
body::before {
  content:''; position:fixed; inset:0; z-index:9990; pointer-events:none;
  background: repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,0.06) 3px,rgba(0,0,0,0.06) 4px);
}

/* ===========================
   ANIMATIONS
=========================== */
@keyframes blink   { 0%,100%{opacity:1}50%{opacity:0} }
@keyframes pulse   { 0%,100%{opacity:1}50%{opacity:0.6} }
@keyframes flicker { 0%,18%,22%,25%,53%,57%,100%{opacity:1}20%,24%,55%{opacity:0.5} }
@keyframes scan    { 0%{transform:translateY(-100%);opacity:0.5}100%{transform:translateY(200vh);opacity:0} }
@keyframes slideUp { from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)} }
@keyframes float   { 0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)} }
@keyframes rotate-hint {
  0%,25%  { transform:rotate(0deg); }
  55%,85% { transform:rotate(90deg); }
  100%    { transform:rotate(0deg); }
}

/* ===========================
   BACKGROUND
=========================== */
.game-bg {
  position:fixed; inset:0; z-index:0;
  background:
    radial-gradient(ellipse 60% 50% at 20% 30%, rgba(57,255,20,0.03) 0%, transparent 65%),
    radial-gradient(ellipse 50% 50% at 80% 70%, rgba(57,255,20,0.02) 0%, transparent 60%),
    var(--void);
}
.game-grid-bg {
  position:fixed; inset:0; z-index:0;
  background-image:
    linear-gradient(rgba(57,255,20,0.015) 1px, transparent 1px),
    linear-gradient(90deg, rgba(57,255,20,0.015) 1px, transparent 1px);
  background-size:48px 48px;
}
.game-scan {
  position:fixed; left:0; right:0; height:1px;
  background:linear-gradient(90deg,transparent,rgba(57,255,20,0.3),transparent);
  animation:scan 6s linear infinite; z-index:1;
}

/* ===========================
   NAVBAR
=========================== */
.game-nav {
  position:fixed; top:0; left:0; right:0; z-index:1000;
  height:56px; display:flex; align-items:center; justify-content:space-between;
  padding:0 24px;
  background:rgba(3,4,10,0.9);
  backdrop-filter:blur(24px);
  border-bottom:1px solid var(--border);
}
.nav-left  { display:flex; align-items:center; gap:16px; }
.nav-right-info { display:flex; align-items:center; gap:16px; }
.back-btn {
  font-family:var(--font-pixel); font-size:7px; letter-spacing:1px;
  color:var(--muted); text-decoration:none; padding:6px 12px;
  border:1px solid var(--border); transition:all 0.2s;
  display:flex; align-items:center; gap:8px;
}
.back-btn:hover { color:var(--chill); border-color:rgba(57,255,20,0.3); }
.nav-title {
  font-family:var(--font-pixel); font-size:9px; letter-spacing:2px;
  color:var(--chill); text-shadow:0 0 12px rgba(57,255,20,0.5);
  animation:flicker 8s infinite;
}
.nav-hi-score {
  font-family:var(--font-pixel); font-size:7px; color:var(--gold);
  text-shadow:0 0 8px rgba(255,215,0,0.4);
}

/* ===========================
   MAIN WRAPPER
=========================== */
.game-wrapper {
  position:relative; z-index:2;
  flex:1; display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  padding:72px 20px 20px;
  gap:16px;
}

/* ===========================
   HUD
=========================== */
.hud {
  display:flex; align-items:center; justify-content:space-between;
  width:100%; max-width:720px;
  padding:10px 20px;
  background:var(--surface);
  border:1px solid var(--border);
  clip-path:polygon(0 0,calc(100% - 8px) 0,100% 8px,100% 100%,8px 100%,0 calc(100% - 8px));
}
.hud-block { text-align:center; }
.hud-label {
  font-family:var(--font-pixel); font-size:6px; letter-spacing:2px;
  color:var(--muted); margin-bottom:2px;
}
.hud-val { font-family:var(--font-pixel); font-size:12px; letter-spacing:1px; }
.hud-score  { color:var(--chill);  text-shadow:var(--chill-glow); }
.hud-level  { color:var(--gold);   text-shadow:0 0 12px rgba(255,215,0,0.4); }
.hud-hi     { color:var(--aqua);   text-shadow:0 0 12px rgba(0,212,255,0.4); }
.hud-length { color:var(--wizard); text-shadow:0 0 12px rgba(168,85,247,0.4); }

/* ===========================
   CANVAS FRAME
=========================== */
.canvas-frame {
  position:relative;
  background:var(--surface);
  border:2px solid rgba(57,255,20,0.2);
  box-shadow:0 0 60px rgba(57,255,20,0.08), inset 0 0 60px rgba(0,0,0,0.5);
  clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,12px 100%,0 calc(100% - 12px));
  overflow:hidden;
}
.canvas-frame::before {
  content:''; position:absolute; inset:0; z-index:2; pointer-events:none;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(57,255,20,0.012) 2px,rgba(57,255,20,0.012) 4px);
}
.canvas-frame::after {
  content:''; position:absolute; top:0; left:0; right:0; height:1px; z-index:3;
  background:linear-gradient(90deg,transparent,var(--chill),transparent); opacity:0.5;
}
#gameCanvas {
  display:block;
  image-rendering:pixelated;
  image-rendering:crisp-edges;
}

/* ===========================
   CONTROLS BAR (desktop)
=========================== */
.controls-bar {
  display:flex; align-items:center; justify-content:center; gap:24px;
  width:100%; max-width:720px; padding:8px 16px;
  background:rgba(15,22,40,0.6); border:1px solid var(--border);
}
.ctrl-hint {
  font-family:var(--font-pixel); font-size:6px; letter-spacing:1px;
  color:var(--muted); display:flex; align-items:center; gap:6px;
}
.key-badge {
  display:inline-flex; align-items:center; justify-content:center;
  min-width:22px; height:18px; padding:0 4px;
  background:var(--raised); border:1px solid rgba(57,255,20,0.2);
  font-family:var(--font-pixel); font-size:6px; color:var(--chill);
}

/* ===========================
   OVERLAY SCREENS
=========================== */
.overlay {
  position:absolute; inset:0; z-index:10;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  background:rgba(3,4,10,0.92);
  backdrop-filter:blur(6px);
  text-align:center; gap:20px; padding:32px;
}
.overlay.hidden { display:none; }
.overlay-title {
  font-family:var(--font-display); font-weight:800;
  font-size:clamp(28px,5vw,48px); line-height:1.1;
  animation:slideUp 0.6s ease-out;
}
.overlay-title .accent { color:var(--chill); text-shadow:var(--chill-glow); }
.overlay-sub {
  font-family:var(--font-pixel); font-size:7px; letter-spacing:1px;
  color:var(--muted); max-width:360px; line-height:2.2;
  animation:slideUp 0.6s ease-out 0.1s both;
}
.overlay-art {
  font-size:52px; animation:float 3s ease-in-out infinite;
  filter:drop-shadow(0 0 20px rgba(57,255,20,0.5));
}
.overlay-score-big {
  font-family:var(--font-display); font-weight:800;
  font-size:52px; color:var(--chill);
  text-shadow:var(--chill-glow);
  animation:slideUp 0.5s ease-out 0.15s both;
}
.go-stats {
  display:flex; gap:24px;
  animation:slideUp 0.5s ease-out 0.25s both;
}
.go-stat { text-align:center; }
.go-stat-val { font-family:var(--font-display); font-weight:700; font-size:22px; color:var(--aqua); }
.go-stat-lbl { font-family:var(--font-pixel); font-size:6px; color:var(--muted); letter-spacing:1px; margin-top:2px; }
.new-record {
  font-family:var(--font-pixel); font-size:8px;
  color:var(--gold); text-shadow:0 0 12px rgba(255,215,0,0.5);
  animation:blink 0.8s infinite;
}
.pause-options { display:flex; gap:12px; animation:slideUp 0.4s ease-out 0.1s both; }
.pause-btn {
  font-family:var(--font-pixel); font-size:8px; letter-spacing:1px;
  padding:12px 20px; cursor:pointer; transition:all 0.2s;
  border:1px solid var(--border); background:var(--surface); color:var(--white);
}
.pause-btn:hover { border-color:var(--chill); color:var(--chill); }
.pause-btn.primary { background:var(--chill); color:var(--void); border-color:var(--chill); }
.pause-btn.primary:hover { background:var(--white); }
.start-btn {
  font-family:var(--font-pixel); font-size:10px; letter-spacing:2px;
  padding:16px 36px; background:var(--chill); color:var(--void); border:none;
  cursor:pointer; transition:all 0.2s;
  clip-path:polygon(0 0,calc(100% - 10px) 0,100% 10px,100% 100%,10px 100%,0 calc(100% - 10px));
  animation:slideUp 0.6s ease-out 0.3s both;
}
.start-btn:hover { background:var(--white); transform:translateY(-3px); box-shadow:0 12px 32px rgba(57,255,20,0.35); }

/* Difficulty select */
.diff-select {
  display:flex; gap:10px;
  animation:slideUp 0.6s ease-out 0.2s both;
}
.diff-btn {
  display:flex; flex-direction:column; align-items:center; gap:6px;
  padding:12px 14px; background:var(--surface); border:2px solid var(--border);
  color:var(--muted); cursor:pointer; transition:all 0.2s;
  font-family:var(--font-pixel); font-size:6px; letter-spacing:1px; min-width:80px;
}
.diff-btn .diff-icon { font-size:22px; transition:transform 0.3s; }
.diff-btn:hover .diff-icon { transform:scale(1.2); }
.diff-btn:hover, .diff-btn.selected {
  border-color:var(--chill); background:var(--chill-dim); color:var(--chill);
  box-shadow:0 0 16px rgba(57,255,20,0.2);
}

/* ===========================
   TOUCH BUTTONS
=========================== */
.touch-btn {
  background:rgba(15,22,40,0.9);
  border:2px solid rgba(57,255,20,0.3);
  color:var(--chill); font-size:20px;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer;
  -webkit-user-select:none; user-select:none;
  touch-action:manipulation; border-radius:6px;
  transition:background 0.06s, border-color 0.06s, box-shadow 0.06s;
  -webkit-tap-highlight-color:transparent;
}
.touch-btn:active, .touch-btn.pressed {
  background:var(--chill-dim); border-color:var(--chill);
  box-shadow:0 0 16px rgba(57,255,20,0.4); transform:scale(0.92);
}
.touch-pause {
  border-color:rgba(255,255,255,0.12); color:var(--muted); border-radius:4px;
}
.touch-pause:active, .touch-pause.pressed {
  border-color:var(--aqua); color:var(--aqua); box-shadow:0 0 14px rgba(0,212,255,0.3);
}

/* ===========================
   PORTRAIT D-PAD (below canvas)
=========================== */
.touch-controls {
  display:none;
  width:100%; max-width:720px;
  padding:10px 20px;
  justify-content:center; align-items:center;
  background:rgba(8,12,24,0.85);
  border-top:1px solid var(--border);
  gap:24px; flex-shrink:0;
}
.dpad {
  display:grid;
  grid-template-areas:". up ." "left . right" ". down .";
  grid-template-columns:44px 44px 44px;
  grid-template-rows:44px 44px 44px;
  gap:3px;
}
.dpad .touch-btn { width:44px; height:44px; }
.dpad-up    { grid-area:up; }
.dpad-down  { grid-area:down; }
.dpad-left  { grid-area:left; }
.dpad-right { grid-area:right; }
.dpad-center { background:rgba(15,22,40,0.4); border-radius:4px; }
.touch-pause-portrait { width:52px; height:52px; }

/* ===========================
   LANDSCAPE SIDE PANELS
=========================== */
.game-area { display:contents; }
.touch-panel-left,
.touch-panel-right {
  display:none;
  flex-direction:column; align-items:center; justify-content:center;
  padding:10px 8px; gap:8px;
  background:rgba(8,12,24,0.8);
  border-top:1px solid var(--border);
  flex-shrink:0; width:86px;
}
.touch-panel-left  { border-right:1px solid var(--border); }
.touch-panel-right { border-left:1px solid var(--border); }
.touch-panel-left  .touch-btn { width:62px; height:62px; font-size:22px; }
.touch-panel-right .touch-btn { width:62px; height:62px; font-size:22px; }
.touch-panel-right .touch-pause { width:46px; height:46px; font-size:16px; }

/* ===========================
   PORTRAIT OVERLAY
=========================== */
.portrait-overlay {
  display:none; position:fixed; inset:0; z-index:9999;
  background:rgba(3,4,10,0.97); backdrop-filter:blur(8px);
  flex-direction:column; align-items:center; justify-content:center;
  gap:28px; text-align:center; padding:40px; pointer-events:all;
}
.portrait-overlay.active { display:flex; }
.portrait-phone {
  font-size:72px; display:inline-block;
  animation:rotate-hint 2.8s ease-in-out infinite;
  filter:drop-shadow(0 0 24px rgba(57,255,20,0.5));
}
.portrait-title {
  font-family:var(--font-pixel); font-size:9px;
  letter-spacing:2px; color:var(--chill);
  text-shadow:var(--chill-glow); animation:pulse 2s infinite;
}
.portrait-sub { font-family:var(--font-mono); font-size:14px; color:var(--muted); line-height:1.7; max-width:260px; }
.portrait-hint { font-family:var(--font-pixel); font-size:6px; color:rgba(255,255,255,0.2); letter-spacing:1px; }

/* ===========================
   POINTER: COARSE
=========================== */
@media (pointer:coarse) {
  #gameCanvas { touch-action:none; }
  body { overscroll-behavior:none; }
}

/* ===========================
   PORTRAIT MOBILE
=========================== */
@media (max-width:768px) and (orientation:portrait) {
  .touch-controls { display:flex; }
  .controls-bar   { display:none; }
  .game-wrapper   { padding:64px 8px 8px; gap:8px; }
  .hud            { padding:7px 12px; }
  .game-nav       { padding:0 12px; }
  .nav-title      { font-size:7px; letter-spacing:1px; }
  .back-btn       { font-size:6px; padding:5px 8px; }
  .nav-hi-score   { font-size:6px; }
}
@media (max-width:480px) and (orientation:portrait) {
  .hud { padding:5px 8px; gap:0; }
  .hud-val    { font-size:9px; }
  .hud-label  { font-size:5px; letter-spacing:1px; }
  .hud-block  { padding:0 4px; }
  .overlay    { padding:18px 14px; gap:14px; }
  .overlay-title { font-size:clamp(22px,7vw,38px); }
  .overlay-sub   { font-size:6px; }
  .overlay-score-big { font-size:38px; }
  .go-stats   { gap:14px; flex-wrap:wrap; justify-content:center; }
  .diff-select { flex-wrap:wrap; justify-content:center; }
  .nav-title  { display:none; }
  .dpad .touch-btn { width:40px; height:40px; }
  .dpad {
    grid-template-columns:40px 40px 40px;
    grid-template-rows:40px 40px 40px;
    gap:2px;
  }
}

/* ===========================
   LANDSCAPE MOBILE
=========================== */
@media (orientation:landscape) and (max-height:540px) and (pointer:coarse) {
  html, body { height:100%; overflow:hidden; }
  .game-nav     { height:40px; padding:0 10px; }
  .nav-title    { display:none; }
  .back-btn     { font-size:6px; padding:4px 8px; }
  .nav-hi-score { font-size:6px; }
  .hud { max-width:100%; padding:3px 10px; flex-shrink:0; clip-path:none; }
  .hud-val    { font-size:9px; }
  .hud-label  { font-size:4px; }
  .hud-block  { padding:0 8px; }
  .game-wrapper {
    flex-direction:column;
    padding:40px 0 0 0;
    height:100vh; gap:3px;
    align-items:stretch; justify-content:flex-start;
  }
  .game-area {
    display:flex; flex-direction:row;
    flex:1; min-height:0; align-items:stretch;
  }
  .touch-panel-left, .touch-panel-right { display:flex; }
  .controls-bar   { display:none !important; }
  .touch-controls { display:none !important; }
  .canvas-frame {
    flex:1; min-width:0; clip-path:none;
    display:flex; align-items:center; justify-content:center; overflow:hidden;
  }
  .overlay       { padding:12px 16px; gap:8px; }
  .overlay-title { font-size:clamp(16px,4vw,26px); }
  .overlay-sub   { font-size:6px; line-height:1.7; }
  .overlay-art   { font-size:28px; }
  .overlay-score-big { font-size:28px; }
  .go-stats      { gap:12px; }
  .diff-select   { gap:6px; }
  .diff-btn      { padding:8px 10px; font-size:5px; min-width:66px; }
  .diff-btn .diff-icon { font-size:18px; }
  .start-btn     { padding:10px 22px; font-size:8px; }
  .pause-options { gap:8px; }
  .pause-btn     { padding:8px 14px; font-size:7px; }
}
</style>
</head>
<body>

<div class="game-bg"></div>
<div class="game-grid-bg"></div>
<div class="game-scan"></div>

<!-- Portrait overlay -->
<div class="portrait-overlay" id="portraitOverlay">
  <div class="portrait-phone">üì±</div>
  <div class="portrait-title">TOURNE TON T√âL√âPHONE</div>
  <div class="portrait-sub">Le jeu est optimis√© en mode paysage pour une meilleure exp√©rience</div>
  <div class="portrait-hint">‚Üª ROTATE TO LANDSCAPE</div>
</div>

<!-- Navbar -->
<nav class="game-nav">
  <div class="nav-left">
    <a href="index.html" class="back-btn">‚óÑ RETOUR</a>
    <span class="nav-title">SNAILZ SNAKE</span>
  </div>
  <div class="nav-right-info">
    <span class="nav-hi-score">HI: <span id="navHiScore">00000</span></span>
  </div>
</nav>

<!-- Game Wrapper -->
<div class="game-wrapper">

  <!-- HUD -->
  <div class="hud">
    <div class="hud-block">
      <div class="hud-label">SCORE</div>
      <div class="hud-val hud-score" id="hudScore">00000</div>
    </div>
    <div class="hud-block">
      <div class="hud-label">LEVEL</div>
      <div class="hud-val hud-level" id="hudLevel">01</div>
    </div>
    <div class="hud-block">
      <div class="hud-label">LONGUEUR</div>
      <div class="hud-val hud-length" id="hudLength">03</div>
    </div>
    <div class="hud-block">
      <div class="hud-label">RECORD</div>
      <div class="hud-val hud-hi" id="hudHi">00000</div>
    </div>
  </div>

  <!-- Game area (transparent in portrait, row in landscape) -->
  <div class="game-area">

    <!-- LEFT PANEL landscape: ‚ñ≤ ‚óÑ ‚ñº -->
    <div class="touch-panel-left" id="touchPanelLeft">
      <button class="touch-btn" id="btnUpL">‚ñ≤</button>
      <button class="touch-btn" id="btnLeftL">‚óÑ</button>
      <button class="touch-btn" id="btnDownL">‚ñº</button>
    </div>

    <!-- Canvas + overlays -->
    <div class="canvas-frame" id="canvasFrame">
      <canvas id="gameCanvas" width="720" height="520"></canvas>

      <!-- START SCREEN -->
      <div class="overlay" id="startScreen">
        <div class="overlay-art">üêå</div>
        <div class="overlay-title">SNAILZ<br><span class="accent">SNAKE</span></div>
        <div class="overlay-sub">COLLECTE LA LAITUE.<br>NE TE MORDS PAS LA QUEUE !</div>
        <div class="diff-select" id="diffSelect">
          <button class="diff-btn selected" data-diff="normal" onclick="selectDiff('normal',this)">
            <span class="diff-icon">üêå</span>NORMAL
          </button>
          <button class="diff-btn" data-diff="hard" onclick="selectDiff('hard',this)">
            <span class="diff-icon">üî•</span>HARD
          </button>
          <button class="diff-btn" data-diff="zen" onclick="selectDiff('zen',this)">
            <span class="diff-icon">üåø</span>ZEN
          </button>
        </div>
        <button class="start-btn" onclick="startGame()">‚ñ∫ JOUER</button>
      </div>

      <!-- PAUSE SCREEN -->
      <div class="overlay hidden" id="pauseScreen">
        <div class="overlay-art" style="font-size:36px">‚è∏</div>
        <div class="overlay-title" style="color:var(--aqua);font-size:clamp(24px,4vw,40px)">PAUSE</div>
        <div class="pause-options">
          <button class="pause-btn primary" onclick="resumeGame()">REPRENDRE</button>
          <button class="pause-btn" onclick="quitToMenu()">MENU</button>
        </div>
      </div>

      <!-- GAME OVER SCREEN -->
      <div class="overlay hidden" id="gameOverScreen">
        <div class="overlay-title">GAME<br><span class="accent">OVER</span></div>
        <div class="overlay-score-big" id="goScore">0</div>
        <div class="new-record hidden" id="newRecord">‚òÖ NOUVEAU RECORD ‚òÖ</div>
        <div class="go-stats">
          <div class="go-stat">
            <div class="go-stat-val" id="goLevel">1</div>
            <div class="go-stat-lbl">LEVEL</div>
          </div>
          <div class="go-stat">
            <div class="go-stat-val" id="goLen">3</div>
            <div class="go-stat-lbl">LONGUEUR</div>
          </div>
          <div class="go-stat">
            <div class="go-stat-val" id="goFood">0</div>
            <div class="go-stat-lbl">LAITUES</div>
          </div>
        </div>
        <button class="start-btn" onclick="startGame()">‚ñ∫ REJOUER</button>
        <button class="pause-btn" onclick="quitToMenu()" style="animation:slideUp 0.5s ease-out 0.4s both">MENU</button>
      </div>
    </div>

    <!-- RIGHT PANEL landscape: ‚ñ∫ ‚è∏ -->
    <div class="touch-panel-right" id="touchPanelRight">
      <button class="touch-btn" id="btnRightL">‚ñ∫</button>
      <button class="touch-btn touch-pause" id="btnPauseR">‚è∏</button>
    </div>

  </div><!-- /game-area -->

  <!-- Desktop hints -->
  <div class="controls-bar">
    <div class="ctrl-hint"><span class="key-badge">‚Üë‚Üì‚Üê‚Üí</span> DIRECTION</div>
    <div class="ctrl-hint"><span class="key-badge">WASD</span> ALT</div>
    <div class="ctrl-hint"><span class="key-badge">P</span> PAUSE</div>
    <div class="ctrl-hint"><span class="key-badge">ESC</span> MENU</div>
  </div>

  <!-- Portrait D-pad -->
  <div class="touch-controls" id="touchControls">
    <div class="dpad">
      <button class="touch-btn dpad-up"   id="btnUp">‚ñ≤</button>
      <button class="touch-btn dpad-left" id="btnLeft">‚óÑ</button>
      <div class="dpad-center"></div>
      <button class="touch-btn dpad-right" id="btnRight">‚ñ∫</button>
      <button class="touch-btn dpad-down" id="btnDown">‚ñº</button>
    </div>
    <button class="touch-btn touch-pause touch-pause-portrait" id="btnPause">‚è∏</button>
  </div>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GAME ENGINE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
'use strict';

// ‚îÄ‚îÄ CANVAS ‚îÄ‚îÄ
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const CW = 720, CH = 520;
canvas.width = CW; canvas.height = CH;

// ‚îÄ‚îÄ GRID ‚îÄ‚îÄ
const CELL   = 28;
const GRID_W = 25;
const GRID_H = 18;
const OX = Math.floor((CW - GRID_W * CELL) / 2); // 10
const OY = Math.floor((CH - GRID_H * CELL) / 2); // 8

// ‚îÄ‚îÄ DIFFICULTY CONFIG ‚îÄ‚îÄ
const DIFF = {
  normal: { speed: 155, wallDeath: true,  label: 'NORMAL' },
  hard:   { speed: 100, wallDeath: true,  label: 'HARD'   },
  zen:    { speed: 175, wallDeath: false, label: 'ZEN'    }, // wall wrap-around
};
let difficulty = 'normal';

function selectDiff(d, btn) {
  difficulty = d;
  document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
}

// ‚îÄ‚îÄ GAME STATE ‚îÄ‚îÄ
let G = {
  state: 'menu',
  score: 0,
  level: 1,
  eaten: 0,
  hiScore: parseInt(localStorage.getItem('snailzSnakeHi') || '0'),
};

let snake = [];
let dir = {x:1, y:0};
let nextDir = {x:1, y:0};
let food = {x:0, y:0};
let bonusFood = null;       // golden lettuce (rare)
let bonusTimer = 0;
let particles = [];
let floatingTexts = [];
let frameId = 0;
let gameInterval = null;
let speed = 155;            // ms per tick
let tickFrame = 0;          // animation frame count (for drawMenuBg)

// ‚îÄ‚îÄ INIT GAME ‚îÄ‚îÄ
function initGame() {
  const cfg = DIFF[difficulty];
  speed = cfg.speed;
  G.score = 0;
  G.level = 1;
  G.eaten = 0;
  particles = [];
  floatingTexts = [];
  bonusFood = null;
  bonusTimer = 0;

  // Starting snake: 3 segments facing right, vertically centered
  const sy = Math.floor(GRID_H / 2);
  snake = [
    {x:6, y:sy},
    {x:5, y:sy},
    {x:4, y:sy},
  ];
  dir = {x:1, y:0};
  nextDir = {x:1, y:0};

  spawnFood();
  updateHUD();
}

// ‚îÄ‚îÄ FOOD SPAWN ‚îÄ‚îÄ
function spawnFood() {
  let pos;
  let tries = 0;
  do {
    pos = { x: Math.floor(Math.random() * GRID_W), y: Math.floor(Math.random() * GRID_H) };
    tries++;
  } while (tries < 200 && snake.some(s => s.x === pos.x && s.y === pos.y));
  food = pos;

  // Spawn golden bonus food occasionally (1 in 5 chance)
  if (Math.random() < 0.2 && !bonusFood) {
    setTimeout(() => {
      let bp;
      let t2 = 0;
      do {
        bp = { x: Math.floor(Math.random() * GRID_W), y: Math.floor(Math.random() * GRID_H) };
        t2++;
      } while (t2 < 200 && (snake.some(s => s.x === bp.x && s.y === bp.y) || (food.x === bp.x && food.y === bp.y)));
      bonusFood = bp;
      bonusTimer = 120; // ticks before it disappears
    }, 500);
  }
}

// ‚îÄ‚îÄ GAME TICK ‚îÄ‚îÄ
function tick() {
  if (G.state !== 'playing') return;

  // Apply queued direction
  dir = {...nextDir};

  const head = {x: snake[0].x + dir.x, y: snake[0].y + dir.y};
  const cfg = DIFF[difficulty];

  if (cfg.wallDeath) {
    // Wall = death
    if (head.x < 0 || head.x >= GRID_W || head.y < 0 || head.y >= GRID_H) {
      triggerGameOver();
      return;
    }
  } else {
    // ZEN mode: wrap around
    head.x = (head.x + GRID_W) % GRID_W;
    head.y = (head.y + GRID_H) % GRID_H;
  }

  // Self collision (exclude tail tip ‚Äî it moves out)
  for (let i = 0; i < snake.length - 1; i++) {
    if (snake[i].x === head.x && snake[i].y === head.y) {
      triggerGameOver();
      return;
    }
  }

  snake.unshift(head);

  let grew = false;

  // Eat regular food
  if (head.x === food.x && head.y === food.y) {
    grew = true;
    const pts = G.level * 10;
    G.score += pts;
    G.eaten++;
    spawnParticles(OX + head.x * CELL + CELL/2, OY + head.y * CELL + CELL/2, '#39ff14', 8);
    spawnFloat(OX + head.x * CELL + CELL/2, OY + head.y * CELL, '+' + pts, '#39ff14');

    // Level up every 5 foods eaten
    if (G.eaten % 5 === 0) {
      G.level++;
      speed = Math.max(60, speed - 12);
      restartInterval();
      spawnFloat(OX + head.x * CELL + CELL/2, OY + head.y * CELL - 20, 'LEVEL ' + G.level + '!', '#ffd700');
    }

    if (G.score > G.hiScore) {
      G.hiScore = G.score;
      localStorage.setItem('snailzSnakeHi', G.hiScore);
    }

    spawnFood();
    updateHUD();
  }

  // Eat bonus food
  if (bonusFood && head.x === bonusFood.x && head.y === bonusFood.y) {
    grew = true;
    const bpts = G.level * 50;
    G.score += bpts;
    spawnParticles(OX + head.x * CELL + CELL/2, OY + head.y * CELL + CELL/2, '#ffd700', 12);
    spawnFloat(OX + head.x * CELL + CELL/2, OY + head.y * CELL, '+' + bpts + ' BONUS!', '#ffd700');
    bonusFood = null;
    if (G.score > G.hiScore) {
      G.hiScore = G.score;
      localStorage.setItem('snailzSnakeHi', G.hiScore);
    }
    updateHUD();
  }

  if (!grew) snake.pop();

  // Bonus food timer countdown
  if (bonusFood) {
    bonusTimer--;
    if (bonusTimer <= 0) bonusFood = null;
  }

  draw();
}

function restartInterval() {
  if (gameInterval) clearInterval(gameInterval);
  gameInterval = setInterval(tick, speed);
}

// ‚îÄ‚îÄ GAME FLOW ‚îÄ‚îÄ
function startGame() {
  initGame();
  G.state = 'playing';
  hideAllScreens();
  restartInterval();
  draw();
}

function pauseGame() {
  if (G.state !== 'playing') return;
  G.state = 'paused';
  clearInterval(gameInterval);
  gameInterval = null;
  showScreen('pauseScreen');
}

function resumeGame() {
  if (G.state !== 'paused') return;
  G.state = 'playing';
  hideAllScreens();
  restartInterval();
}

function triggerGameOver() {
  G.state = 'gameover';
  clearInterval(gameInterval);
  gameInterval = null;

  const isRecord = G.score > 0 && G.score >= G.hiScore;
  document.getElementById('goScore').textContent = G.score;
  document.getElementById('goLevel').textContent = G.level;
  document.getElementById('goLen').textContent = snake.length;
  document.getElementById('goFood').textContent = G.eaten;
  document.getElementById('newRecord').classList.toggle('hidden', !isRecord);
  document.getElementById('navHiScore').textContent = String(G.hiScore).padStart(5,'0');
  document.getElementById('hudHi').textContent = String(G.hiScore).padStart(5,'0');

  showScreen('gameOverScreen');
}

function quitToMenu() {
  G.state = 'menu';
  clearInterval(gameInterval);
  gameInterval = null;
  showScreen('startScreen');
}

function showScreen(id) {
  hideAllScreens();
  document.getElementById(id).classList.remove('hidden');
}

function hideAllScreens() {
  document.querySelectorAll('.overlay').forEach(o => o.classList.add('hidden'));
}

// ‚îÄ‚îÄ HUD ‚îÄ‚îÄ
const _hudScore  = document.getElementById('hudScore');
const _hudLevel  = document.getElementById('hudLevel');
const _hudLength = document.getElementById('hudLength');
const _hudHi     = document.getElementById('hudHi');

function updateHUD() {
  _hudScore.textContent  = String(G.score).padStart(5,'0');
  _hudLevel.textContent  = String(G.level).padStart(2,'0');
  _hudLength.textContent = String(snake.length).padStart(2,'0');
  _hudHi.textContent     = String(G.hiScore).padStart(5,'0');
  document.getElementById('navHiScore').textContent = String(G.hiScore).padStart(5,'0');
}

// ‚îÄ‚îÄ PARTICLES ‚îÄ‚îÄ
function spawnParticles(px, py, color, count) {
  for (let i = 0; i < count; i++) {
    const angle = (Math.PI * 2 / count) * i + Math.random() * 0.4;
    const spd = Math.random() * 2.5 + 1;
    particles.push({
      x:px, y:py,
      vx: Math.cos(angle) * spd,
      vy: Math.sin(angle) * spd,
      life: 22 + Math.random() * 14,
      maxLife: 36,
      size: Math.random() * 4 + 2,
      color,
    });
  }
}

function spawnFloat(x, y, text, color) {
  floatingTexts.push({x, y, text, color, life:40, maxLife:40, vy:-1.4});
}

// ‚îÄ‚îÄ DRAWING ‚îÄ‚îÄ
function px(gx) { return OX + gx * CELL; }
function py(gy) { return OY + gy * CELL; }

function drawGrid() {
  // Subtle grid
  ctx.strokeStyle = 'rgba(57,255,20,0.035)';
  ctx.lineWidth = 0.5;
  for (let x = 0; x <= GRID_W; x++) {
    ctx.beginPath(); ctx.moveTo(px(x), py(0)); ctx.lineTo(px(x), py(GRID_H)); ctx.stroke();
  }
  for (let y = 0; y <= GRID_H; y++) {
    ctx.beginPath(); ctx.moveTo(px(0), py(y)); ctx.lineTo(px(GRID_W), py(y)); ctx.stroke();
  }
  // Border
  ctx.strokeStyle = 'rgba(57,255,20,0.18)';
  ctx.lineWidth = 1.5;
  ctx.strokeRect(px(0) - 1, py(0) - 1, GRID_W * CELL + 2, GRID_H * CELL + 2);
}

// Draw snail head ‚Äî direction aware
function drawHead(gx, gy, dx, dy) {
  const cx = px(gx) + CELL/2;
  const cy = py(gy) + CELL/2;
  const R  = CELL / 2 - 1;

  ctx.save();
  ctx.translate(cx, cy);
  // Rotate so "right" is always the facing direction
  const ang = dx === 1 ? 0 : dx === -1 ? Math.PI : dy === -1 ? -Math.PI/2 : Math.PI/2;
  ctx.rotate(ang);

  // Body (green circle/oval)
  ctx.shadowColor = 'rgba(57,255,20,0.7)';
  ctx.shadowBlur  = 14;
  ctx.fillStyle   = '#28d60a';
  ctx.beginPath();
  ctx.ellipse(0, 1, R - 1, R - 2, 0, 0, Math.PI * 2);
  ctx.fill();

  // Shell (on the "back" = negative X side in rotated space)
  ctx.shadowColor = 'rgba(57,255,20,0.35)';
  ctx.shadowBlur  = 6;
  ctx.fillStyle   = '#115c05';
  ctx.beginPath();
  ctx.ellipse(-R * 0.45, 0, R * 0.42, R * 0.38, 0, 0, Math.PI * 2);
  ctx.fill();

  // Shell spiral
  ctx.strokeStyle = 'rgba(57,255,20,0.25)';
  ctx.lineWidth   = 1.2;
  ctx.shadowBlur  = 0;
  ctx.beginPath();
  ctx.arc(-R * 0.45, 0, R * 0.18, -Math.PI * 0.3, Math.PI * 1.1);
  ctx.stroke();
  ctx.beginPath();
  ctx.arc(-R * 0.45, 0, R * 0.08, 0, Math.PI * 2);
  ctx.stroke();

  // Shell highlight dot
  ctx.fillStyle = 'rgba(57,255,20,0.2)';
  ctx.beginPath();
  ctx.arc(-R * 0.55, -R * 0.2, 2, 0, Math.PI * 2);
  ctx.fill();

  // Eyes (on the "front" = positive X, split top/bottom)
  ctx.fillStyle   = '#ffffff';
  ctx.shadowColor = '#ffffff';
  ctx.shadowBlur  = 4;
  ctx.beginPath(); ctx.arc(R * 0.5, -R * 0.3, 3, 0, Math.PI * 2); ctx.fill();
  ctx.beginPath(); ctx.arc(R * 0.5,  R * 0.3, 3, 0, Math.PI * 2); ctx.fill();
  ctx.fillStyle = '#111111';
  ctx.shadowBlur  = 0;
  ctx.beginPath(); ctx.arc(R * 0.5 + 1, -R * 0.3, 1.4, 0, Math.PI * 2); ctx.fill();
  ctx.beginPath(); ctx.arc(R * 0.5 + 1,  R * 0.3, 1.4, 0, Math.PI * 2); ctx.fill();

  // Antennae
  ctx.strokeStyle = '#39ff14';
  ctx.lineWidth   = 1.2;
  ctx.shadowColor = '#39ff14';
  ctx.shadowBlur  = 5;
  const antA = (tickFrame * 0.03); // subtle sway
  ctx.beginPath(); ctx.moveTo(R * 0.25, -R * 0.55); ctx.lineTo(R * 0.55 + Math.sin(antA) * 2, -R + 1); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(R * 0.25,  R * 0.55); ctx.lineTo(R * 0.55 + Math.cos(antA) * 2,  R - 1); ctx.stroke();
  // Antenna tips
  ctx.fillStyle  = '#39ff14';
  ctx.shadowBlur = 8;
  ctx.beginPath(); ctx.arc(R * 0.55 + Math.sin(antA) * 2, -R + 1, 2.2, 0, Math.PI * 2); ctx.fill();
  ctx.beginPath(); ctx.arc(R * 0.55 + Math.cos(antA) * 2,  R - 1, 2.2, 0, Math.PI * 2); ctx.fill();

  ctx.restore();
}

// Draw body segment with shell pattern
function drawBodySeg(seg, idx, total) {
  const m  = 3;
  const sz = CELL - m * 2;
  const t  = idx / Math.max(total, 1); // 0 near head, 1 at tail

  // Color fades from bright to dark green
  const g = Math.floor(200 - t * 110);
  const r = Math.floor(8  + t * 4);
  const b = Math.floor(4  + t * 2);

  ctx.save();
  ctx.shadowColor = `rgba(57,255,20,${0.45 - t * 0.38})`;
  ctx.shadowBlur  = 7 - t * 5;
  ctx.fillStyle   = `rgb(${r},${g},${b})`;
  ctx.beginPath();
  ctx.roundRect(px(seg.x) + m, py(seg.y) + m, sz, sz, 5);
  ctx.fill();

  // Shell pattern every 3rd segment
  if (idx % 3 === 2 && idx > 0) {
    const scx = px(seg.x) + CELL/2;
    const scy = py(seg.y) + CELL/2;
    ctx.shadowBlur  = 0;
    ctx.fillStyle   = `rgba(0,65,0,0.55)`;
    ctx.beginPath();
    ctx.ellipse(scx, scy, sz * 0.3, sz * 0.25, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.strokeStyle = 'rgba(57,255,20,0.18)';
    ctx.lineWidth   = 1;
    ctx.beginPath(); ctx.arc(scx, scy, sz * 0.15, 0, Math.PI * 1.4); ctx.stroke();
  }

  ctx.restore();
}

// Draw food (lettuce)
function drawFood() {
  const pulse = Math.sin(tickFrame * 0.11) * 1.5;
  const fx = px(food.x) + CELL/2;
  const fy = py(food.y) + CELL/2;

  ctx.save();
  ctx.shadowColor = 'rgba(57,255,20,0.9)';
  ctx.shadowBlur  = 18 + pulse;
  ctx.font = `${15 + Math.floor(pulse * 0.3)}px serif`;
  ctx.textAlign    = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('ü•¨', fx, fy + 1);
  ctx.restore();
}

// Draw bonus food (golden snail)
function drawBonusFood() {
  if (!bonusFood) return;
  const pct    = bonusTimer / 120; // 1 ‚Üí 0 as it expires
  const blink  = pct < 0.3 && Math.floor(tickFrame / 4) % 2 === 0; // blink when expiring
  if (blink) return;
  const pulse  = Math.sin(tickFrame * 0.15) * 2;
  const bx = px(bonusFood.x) + CELL/2;
  const by = py(bonusFood.y) + CELL/2;

  ctx.save();
  ctx.shadowColor = 'rgba(255,215,0,0.9)';
  ctx.shadowBlur  = 20 + pulse;
  ctx.font        = `${16 + Math.floor(pulse * 0.3)}px serif`;
  ctx.textAlign   = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('üåü', bx, by + 1);
  ctx.restore();
}

// Main draw
function draw() {
  tickFrame++;
  ctx.clearRect(0, 0, CW, CH);

  // Background
  ctx.fillStyle = '#03040a';
  ctx.fillRect(0, 0, CW, CH);

  drawGrid();
  drawFood();
  drawBonusFood();

  // Body (tail to segment 1)
  for (let i = snake.length - 1; i >= 1; i--) {
    drawBodySeg(snake[i], i, snake.length);
  }
  // Head
  if (snake.length > 0) drawHead(snake[0].x, snake[0].y, dir.x, dir.y);

  // Speed indicator bar
  if (G.state === 'playing') {
    const pct = Math.min(1, (DIFF[difficulty].speed - speed) / (DIFF[difficulty].speed - 60));
    ctx.fillStyle = 'rgba(255,255,255,0.08)';
    ctx.fillRect(OX, CH - 18, GRID_W * CELL, 4);
    ctx.fillStyle = `hsl(${120 - pct * 120},100%,60%)`;
    ctx.shadowColor = ctx.fillStyle; ctx.shadowBlur = 6;
    ctx.fillRect(OX, CH - 18, GRID_W * CELL * pct, 4);
    ctx.shadowBlur = 0;
    ctx.font = '6px "Press Start 2P"';
    ctx.fillStyle = 'rgba(255,255,255,0.25)';
    ctx.textAlign = 'left';
    ctx.fillText('VITESSE', OX, CH - 22);
  }

  // ZEN mode indicator
  if (DIFF[difficulty].wallDeath === false && G.state === 'playing') {
    ctx.font = '6px "Press Start 2P"';
    ctx.fillStyle = 'rgba(57,255,20,0.35)';
    ctx.textAlign = 'right';
    ctx.fillText('ZEN MODE ‚Äî LES MURS NE TUENT PAS', OX + GRID_W * CELL, CH - 22);
  }

  // Particles
  particles = particles.filter(p => {
    p.x += p.vx; p.y += p.vy; p.vy += 0.04; p.life--;
    ctx.save();
    ctx.globalAlpha = p.life / p.maxLife;
    ctx.fillStyle   = p.color;
    ctx.shadowColor = p.color; ctx.shadowBlur = 4;
    ctx.fillRect(p.x, p.y, p.size, p.size);
    ctx.restore();
    return p.life > 0;
  });

  // Floating texts
  floatingTexts = floatingTexts.filter(f => {
    f.y += f.vy; f.life--;
    ctx.save();
    ctx.globalAlpha = f.life / f.maxLife;
    ctx.font = '9px "Press Start 2P"';
    ctx.fillStyle   = f.color;
    ctx.shadowColor = f.color; ctx.shadowBlur = 8;
    ctx.textAlign   = 'center';
    ctx.fillText(f.text, f.x, f.y);
    ctx.restore();
    return f.life > 0;
  });
}

// Ambient menu background
function drawMenuBg() {
  tickFrame++;
  ctx.clearRect(0, 0, CW, CH);
  ctx.fillStyle = '#03040a';
  ctx.fillRect(0, 0, CW, CH);
  drawGrid();

  // Animate a demo snail wandering around
  const demoLen = 8;
  const t = tickFrame * 0.008;
  for (let i = 0; i < demoLen; i++) {
    const angle = t - i * 0.25;
    const sx = Math.floor(GRID_W/2 + Math.cos(angle) * 5);
    const sy = Math.floor(GRID_H/2 + Math.sin(angle) * 3);
    const seg = {x: Math.max(0,Math.min(GRID_W-1,sx)), y: Math.max(0,Math.min(GRID_H-1,sy))};
    if (i === 0) {
      const ddx = Math.cos(angle) > 0 ? 1 : -1;
      const ddy = 0;
      drawHead(seg.x, seg.y, ddx, ddy);
    } else {
      drawBodySeg(seg, i, demoLen);
    }
  }
  // Animated food
  const fx = Math.floor(GRID_W/2 + Math.cos(t * 0.3) * 8);
  const fy = Math.floor(GRID_H/2 + Math.sin(t * 0.5) * 5);
  food = {x: Math.max(0,Math.min(GRID_W-1,fx)), y: Math.max(0,Math.min(GRID_H-1,fy))};
  drawFood();

  frameId = requestAnimationFrame(drawMenuBg);
}

// ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ
const keys = {};
window.addEventListener('keydown', e => {
  keys[e.code] = true;
  if (G.state === 'playing') {
    if ((e.code === 'ArrowLeft'  || e.code === 'KeyA') && dir.x === 0) nextDir = {x:-1, y:0};
    if ((e.code === 'ArrowRight' || e.code === 'KeyD') && dir.x === 0) nextDir = {x:1,  y:0};
    if ((e.code === 'ArrowUp'    || e.code === 'KeyW') && dir.y === 0) nextDir = {x:0, y:-1};
    if ((e.code === 'ArrowDown'  || e.code === 'KeyS') && dir.y === 0) nextDir = {x:0,  y:1};
    if (e.code === 'KeyP') pauseGame();
    if (e.code === 'Escape') pauseGame();
  } else if (G.state === 'paused') {
    if (e.code === 'KeyP' || e.code === 'Escape') resumeGame();
  }
  if (['Space','ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.code)) e.preventDefault();
});
window.addEventListener('keyup', e => { keys[e.code] = false; });

// Swipe detection on canvas
let touchStart = null;
canvas.addEventListener('touchstart', e => {
  touchStart = {x: e.touches[0].clientX, y: e.touches[0].clientY};
}, {passive: true});
canvas.addEventListener('touchend', e => {
  if (!touchStart) return;
  const dx = e.changedTouches[0].clientX - touchStart.x;
  const dy = e.changedTouches[0].clientY - touchStart.y;
  touchStart = null;
  if (Math.abs(dx) < 18 && Math.abs(dy) < 18) return;
  if (G.state !== 'playing') return;
  if (Math.abs(dx) > Math.abs(dy)) {
    if (dx > 0 && dir.x === 0) nextDir = {x:1, y:0};
    if (dx < 0 && dir.x === 0) nextDir = {x:-1, y:0};
  } else {
    if (dy > 0 && dir.y === 0) nextDir = {x:0, y:1};
    if (dy < 0 && dir.y === 0) nextDir = {x:0, y:-1};
  }
}, {passive: true});

// ‚îÄ‚îÄ TOUCH CONTROLS SETUP ‚îÄ‚îÄ
function setupTouch() {
  function bindDir(el, dx, dy) {
    if (!el) return;
    function press(e) {
      e.preventDefault();
      if (G.state !== 'playing') return;
      if (dx !== 0 && dir.x === 0) nextDir = {x:dx, y:0};
      if (dy !== 0 && dir.y === 0) nextDir = {x:0, y:dy};
      el.classList.add('pressed');
    }
    function release(e) { e.preventDefault(); el.classList.remove('pressed'); }
    el.addEventListener('touchstart', press,   {passive:false});
    el.addEventListener('touchend',   release, {passive:false});
    el.addEventListener('touchcancel',release);
    el.addEventListener('mousedown',  press);
    el.addEventListener('mouseup',    release);
    el.addEventListener('mouseleave', release);
  }
  function bindPause(el) {
    if (!el) return;
    const t = e => {
      e.preventDefault();
      if (G.state === 'playing') pauseGame();
      else if (G.state === 'paused') resumeGame();
    };
    el.addEventListener('touchstart', t, {passive:false});
    el.addEventListener('mousedown',  t);
  }

  // Portrait D-pad
  bindDir(document.getElementById('btnUp'),    0, -1);
  bindDir(document.getElementById('btnDown'),  0,  1);
  bindDir(document.getElementById('btnLeft'), -1,  0);
  bindDir(document.getElementById('btnRight'), 1,  0);
  bindPause(document.getElementById('btnPause'));

  // Landscape panels
  bindDir(document.getElementById('btnUpL'),    0, -1);
  bindDir(document.getElementById('btnDownL'),  0,  1);
  bindDir(document.getElementById('btnLeftL'), -1,  0);
  bindDir(document.getElementById('btnRightL'), 1,  0);
  bindPause(document.getElementById('btnPauseR'));
}
setupTouch();

// ‚îÄ‚îÄ ORIENTATION & RESIZE ‚îÄ‚îÄ
function isTouchDevice() {
  return navigator.maxTouchPoints > 0 || 'ontouchstart' in window;
}

function resizeCanvas() {
  const touch     = isTouchDevice();
  const landscape = window.innerWidth > window.innerHeight;
  const W = window.innerWidth, H = window.innerHeight;
  let maxW;

  if (touch && landscape && H <= 540) {
    // Landscape mobile: left panel (86) + canvas + right panel (86)
    const panelW = 86 * 2, navH = 40, hudH = 32, gapH = 6;
    const availW = W - panelW;
    const availH = H - navH - hudH - gapH;
    maxW = Math.floor(Math.min(availW, availH * (CW / CH)));
  } else if (touch && !landscape) {
    // Portrait: nav(56) + hud(50) + dpad(138) + gaps(20)
    const navH = 56, hudH = 50, ctrlH = 138, gapH = 20;
    const byW  = Math.min(CW, W - 32);
    const byH  = (H - navH - hudH - ctrlH - gapH) * (CW / CH);
    maxW = Math.floor(Math.min(byW, byH));
  } else {
    maxW = Math.min(CW, W - 80);
  }

  maxW = Math.max(200, maxW);
  canvas.style.width  = maxW + 'px';
  canvas.style.height = Math.floor(maxW * (CH / CW)) + 'px';
}

function updateOrientation() {
  const touch    = isTouchDevice();
  const portrait = window.innerWidth < window.innerHeight;
  const overlay  = document.getElementById('portraitOverlay');

  if (touch && portrait && window.innerWidth < 768) {
    overlay.classList.add('active');
    if (G.state === 'playing') pauseGame();
  } else {
    overlay.classList.remove('active');
  }
  resizeCanvas();
}

window.addEventListener('resize', updateOrientation);
window.addEventListener('orientationchange', () => setTimeout(updateOrientation, 250));

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
G.hiScore = parseInt(localStorage.getItem('snailzSnakeHi') || '0');
document.getElementById('navHiScore').textContent = String(G.hiScore).padStart(5,'0');
document.getElementById('hudHi').textContent      = String(G.hiScore).padStart(5,'0');

updateOrientation();
drawMenuBg();
</script>
</body>
</html>
